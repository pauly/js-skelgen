/**
 * Vows skeleton test generator
 * A work very much in progress
 * https://github.com/pauly/vows-skelgen
 * 
 * @author PC <paulypopex@gmail.com>
 */

var badInputs = [ 'foo', 66, undefined, null, [ ], { }, 'new Date( )' ];

var baseName = function ( file ) {
  file = '' + file;
  var base = file.substring( file.lastIndexOf( '/' ) + 1 );
  if ( base.lastIndexOf( '.' ) == -1 ) {
    return base;
  }
  return base.substring( 0, base.lastIndexOf( '.' ));
};

var getFile = function ( ) {
  if ( ! process.argv[2] ) {
    console.error( 'usage: node', process.argv[1], '[file] > [outputfile]' );
    console.error( '(or node', process.argv[1], '[file] | node)' );
    process.exit( 1 );
  }
  var file = process.argv[2];
  if ( /^\w/.exec( file )) {
    file = process.cwd( ) + '/' + file;
  }
  return file;
};

var writeTests = function ( methodName, obj ) {
  var args = /\((.+)\)/.exec( obj.toString( ))
    .pop( )
    .split( ',' )
    .map( function ( a ) { return a.trim( ); } );
  var test = '';
  if ( args[ args.length - 1 ] == 'callback' ) {
    return asyncTests( methodName, args );
  }
  return syncTests( methodName, args );
};

var asyncTests = function ( methodName, args ) {
  /* 'handles good input': {
    topic: function ( ) {
      availability.get( { foo: true }, this.callback );
    },
    callback: function( err, result ) {
      assert.equal( err, null );
    },
    'handles bad input': {
      'handles foo': {
        topic: function ( ) {
          availability.get( 'foo', this.callback );
        },
        callback: function ( err, result ) {
        }
      },
  */
  return '/* no async tests for ' + methodName + ' yet */';
};

var syncTests = function ( methodName, args ) {
  var test = '  \'' + methodName + '\': {\n' +
    '    /* args = ' + JSON.stringify( args ) + ' */\n' +
    '    \'handles good input\': function ( ) {\n' +
    '      // var result = ' + methodName + '( );\n' +
    '      // var expect = { };\n' +
    '      // assert.equal( result, expect );\n' +
    '    },\n' +
    '    \'handles bad input\': {\n';
  for ( var i = 0; i < badInputs.length; i ++ ) {
    if ( i ) {
      test += ',\n';
    }
    var data = badInputs[ i ];
    if ( data ) {
      data = JSON.stringify( badInputs[ i ] )
        .replace( /"/g, '\'' )
        .replace( /'new Date\( \)'/, 'new Date( )' );
    }
    var title = ( '' + data ).replace( /'/g, '' );
    var params = args.map( function ( f ) { return data; } );
    test += '      \'handles ' + title + '\': function ( ) {\n' +
      '        assert.doesNotThrow(\n' +
      '          function ( ) {\n' +
      '            ' + methodName + '( ' + params + ' );\n' +
      '          }\n' +
      '        );\n' +
      '        var result = ' + methodName + '( ' + params + ' );\n' +
      '        // assert.equal( result, null );\n' +
      '      }';
  }
  test += '\n    }\n' +
    '  }';
  return test;
};

var file = getFile( );
var name = baseName( file );
var obj = require( file );
var functions = obj;
var content = '/**\n * generated by ' + process.argv[1] + '\n' +
  ' * https://github.com/pauly/vows-skelgen\n' +
  ' * @todo parse the file and use params / @assert rules\n' +
  ' * ' + new Date( ) + '\n */\n\n' +
  'var assert = require( \'assert\' );\n' +
  'var vows = require( \'vows\' );\n' +
  'var file = \'' + file + '\';\n' +
  'var ' + name + ' = require( file );\n\n' +
  'vows.describe( \'' + name + '\' ).addBatch( {\n';
var gotFunctions = false;
for ( var methodName in functions ) {
  if ( functions.hasOwnProperty( methodName )) {
    if ( functions[ methodName ] instanceof Function ) {
      if ( gotFunctions ) {
        content += ',\n';
      }
      content += writeTests( name + '.' + methodName, functions[ methodName ] );
      gotFunctions = true;
    }
  }
}
if ( ! gotFunctions ) {
  content += writeTests( name, obj );
}
content += '\n' +
  '} ).run( );\n';

console.log( content );
